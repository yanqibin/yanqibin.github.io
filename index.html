<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="yanqibin">
<meta property="og:type" content="website">
<meta property="og:title" content="yanqibin 个人博客">
<meta property="og:url" content="https://yanqibin.github.io/index.html">
<meta property="og:site_name" content="yanqibin 个人博客">
<meta property="og:description" content="yanqibin">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="yanqibin 个人博客">
<meta name="twitter:description" content="yanqibin">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://yanqibin.github.io/">





  <title>yanqibin 个人博客</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">yanqibin 个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">yanqibin</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yanqibin.github.io/2022/01/12/Thinkphp-go-mysql-elasticsearc-elasticsearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanqibin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yanqibin 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/01/12/Thinkphp-go-mysql-elasticsearc-elasticsearch/" itemprop="url">Thinkphp + go-mysql-elasticsearc + elasticsearch</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-01-12T17:44:17+08:00">
                2022-01-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p>项目使用 thinkphp  + mysql 对列表进行查询，列表数据量达到千万级别，且搜索维度效果，故采用elasticsearch进行搜索</p>
<p>为了尽量不改动代码逻辑，需要实现</p>
</blockquote>
<ul>
<li>数据自动同步至ES ( 使用  go-mysql-elasticsearch）</li>
<li>平滑切换TP自带的数据库查询操作到ES（自定义 query，转化TP 的查询条件为 ES的查询条件）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">A --&gt; | go-mysql-elasticsearc 初始化时自动导出数据为SQL|G(sql)</span><br><span class="line">A[mysql] --&gt; |mysql开启log row格式|B(binlog)</span><br><span class="line"></span><br><span class="line">G --&gt; |解析SQL文件|D</span><br><span class="line">B --&gt; |伪装成从库  请求 数据| D[go-mysql-elasticsearch]</span><br><span class="line">D --&gt;|同步数据|F(elasticsearch)</span><br><span class="line"></span><br><span class="line">Z[ES 数据流程图]</span><br></pre></td></tr></table></figure>
<p><img src="\uploads\images\go-mysql-elasticsearch.jpg" alt></p>
<h1 id="功能使用"><a href="#功能使用" class="headerlink" title="功能使用"></a>功能使用</h1><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><blockquote>
<p> php 中\think\db\query\Elasticsearch  为 处理 TP语法到 ES 中的的查询语法，调用方式通DB 相同</p>
<p>暂只支持where , whereor ,wherein  , limit ,  order  ,find select  ,value ,sum 方法</p>
</blockquote>
<ul>
<li>查询方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Elasticsearch\Elasticsearch\FinanceBillIncome::where(&apos;xxx&apos;,&apos;xxx&apos;)-&gt;find();</span><br></pre></td></tr></table></figure>
<ul>
<li>列表时 先通过ES 查询出主键ID, 再通过主键 查询出明细数据</li>
<li>列表查询通过 count 方法</li>
<li>列表头部统计 ，通过如下方式查询</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-&gt;sum(   [</span><br><span class="line">                     <span class="string">'expect_fee'</span>,</span><br><span class="line">                     <span class="string">'adjustment_fee'</span>,</span><br><span class="line">                     <span class="string">'confirm_fee'</span>,</span><br><span class="line">                 ]);</span><br></pre></td></tr></table></figure>
<ul>
<li><p>暂不支持 join，必须join 的降级为DB 处理</p>
</li>
<li><p>alias 方法指定后，ES 查询时将 自动去除查询条件与字段中头部别名</p>
</li>
</ul>
<h3 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h3><blockquote>
<p>先通过</p>
</blockquote>
<ul>
<li><p>.env</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 搜索引擎地址</span><br><span class="line">ELASTICSEARCH_HOST_NAME=&apos;192.168.x&apos;x.133&apos;</span><br><span class="line">ELASTICSEARCH_HOST_PORT=&apos;9200&apos;</span><br><span class="line">ELASTICSEARCH_INDEX_PREFIX=&apos;xxx_&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>database.php</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'elasticsearch'</span>=&gt;[</span><br><span class="line">    <span class="string">'prefix'</span> =&gt;  env(<span class="string">'ELASTICSEARCH_INDEX_PREFIX'</span>),</span><br><span class="line">    <span class="string">'type'</span>     =&gt; <span class="string">'elasticsearch'</span>,</span><br><span class="line">    <span class="string">'hostname'</span> =&gt; env(<span class="string">'ELASTICSEARCH_HOST_NAME'</span>),</span><br><span class="line">    <span class="string">'hostport'</span> =&gt; env(<span class="string">'ELASTICSEARCH_HOST_PORT'</span>),</span><br><span class="line">    <span class="string">'debug'</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">    <span class="comment">// 是否严格检查字段是否存在</span></span><br><span class="line">    <span class="string">'fields_strict'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">    <span class="comment">// 数据集返回类型 array 数组 collection Collection对象</span></span><br><span class="line">    <span class="string">'resultset_type'</span> =&gt; <span class="string">'array'</span>,</span><br><span class="line">    <span class="string">'sql_explain'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">'query'</span>           =&gt; <span class="string">'\\think\\db\\query\\Elasticsearch'</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<ul>
<li><p>builder <a href="\uploads\file\elasticsearch\think\db\builder\Elasticsearch.php">文件</a></p>
</li>
<li><p>connector<a href="\uploads\file\elasticsearch\think\db\connector\Elasticsearch.php">文件</a></p>
</li>
<li><p>query<a href="\uploads\file\elasticsearch\think\db\query\Elasticsearch.php">文件</a></p>
</li>
<li><p>新增 class  如</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Elasticsearch\Elasticsearch\FinanceBillIncome</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化 ES，创建 index</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/cron/elasticsearch/initSearch</span><br></pre></td></tr></table></figure>
<ul>
<li>输出的内容 为 go-mysql-elasticsearch 中的配置</li>
<li>启动  go-mysql-elasticsearch</li>
</ul>
<h1 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h1><ol>
<li>定时 monitor 表中更新时间</li>
<li>定时查询ES 中monitor  的时间</li>
<li>对比时间差异，差异时间为延迟时间</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yanqibin.github.io/2018/02/22/php-resque延迟执行与失败重试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanqibin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yanqibin 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/22/php-resque延迟执行与失败重试/" itemprop="url">php-resque延迟执行与失败重试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-22T13:19:35+08:00">
                2018-02-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一、前言</p>
<pre><code>使用第三方库进行短信发送等，为了响应速度，失败延迟重试等，决定使用消息队列。
</code></pre><p>二、 使用 </p>
<p>   php-resque 在网上有不少教程在此便不加以累赘 ，参考地址: <a href="http://blog.csdn.net/maquealone/article/details/75333349" target="_blank" rel="noopener">PHP-resque使用经验总结</a></p>
<p>三、结构分析</p>
<p>   从push与pop方法中可看出，队列中使用redis的List（列表）右侧插入数据，左侧取出数据。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Resque()&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">push</span><span class="params">($queue, $item)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">self</span>::redis()-&gt;sadd(<span class="string">'queues'</span>, $queue);</span><br><span class="line">		<span class="keyword">self</span>::redis()-&gt;rpush(<span class="string">'queue:'</span> . $queue, json_encode($item));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">pop</span><span class="params">($queue)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		$item = <span class="keyword">self</span>::redis()-&gt;lpop(<span class="string">'queue:'</span> . $queue);</span><br><span class="line">		<span class="keyword">if</span>(!$item) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> json_decode($item, <span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>四、 结构设计</p>
<p>   List结构不能完成延迟执行这一功能，为此新增两个redis key 分别为SortedSet（有序集合） 与Hash（哈希表），<br>将队列数据放在Hash表中， 将数据的Key 放入 SortedSet 中 其中 到达可执行的时间戳为Sort ，当 Sort 小于当前时间时，则将Hash 表中的数据移动至 List 队列中右侧，排队执行</p>
<p>五、 代码实现</p>
<p>Resque_Job 中</p>
<p><code>$this-&gt;instance-&gt;queue = $this-&gt;queue;</code></p>
<p>后插入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行次数</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;instance-&gt;try_time = <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;payload[<span class="string">'try_time'</span>] ) ? <span class="keyword">$this</span>-&gt;payload[<span class="string">'try_time'</span>] : <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>Resque_Job 中插入3个方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Resque_Job</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 超时执行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>      $queue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>      $class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> null $args</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>      $delay</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool $monitor</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span>  <span class="function"><span class="keyword">function</span> <span class="title">delay</span><span class="params">($queue, $class, $args = null, $delay=<span class="number">60</span>,$monitor = false)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($args !== <span class="keyword">null</span> &amp;&amp; !is_array($args)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(</span><br><span class="line">                <span class="string">'Supplied $args must be an array.'</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        $id = md5(uniqid(<span class="string">''</span>, <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">        Resque::later($queue,</span><br><span class="line">            <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">'class'</span>	=&gt;$class,</span><br><span class="line">                <span class="string">'args'</span>	=&gt; <span class="keyword">array</span>($args),</span><br><span class="line">                <span class="string">'id'</span>	=&gt;$id,</span><br><span class="line">            ),$delay);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($monitor) &#123;</span><br><span class="line">            Resque_Job_Status::create($id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $id;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重试</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $delay</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delayJob</span><span class="params">($delay)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;payload[<span class="string">'try_time'</span>] =( <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;payload[<span class="string">'try_time'</span>])&amp;&amp; <span class="keyword">$this</span>-&gt;payload[<span class="string">'try_time'</span>]&gt;<span class="number">1</span>) ? <span class="keyword">$this</span>-&gt;payload[<span class="string">'try_time'</span>] : <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;payload[<span class="string">'try_time'</span>]++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Resque::later(<span class="keyword">$this</span>-&gt;queue, <span class="keyword">$this</span>-&gt;payload, $delay);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  加载延迟数据</span></span><br><span class="line"><span class="comment">     *  到达延迟时间的 Job 从Hash移动至 List队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $queue</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">loadDelay</span><span class="params">($queue)</span></span>&#123;</span><br><span class="line">               <span class="keyword">return</span>  Resque::move($queue);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>reidis 支持</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Resque_Redis</span> <span class="keyword">extends</span> <span class="title">Redisent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $keyCommands = <span class="keyword">array</span>(</span><br><span class="line">            ...</span><br><span class="line">    	<span class="string">'zremrangebyscore'</span>,</span><br><span class="line">	<span class="string">'sort'</span>,</span><br><span class="line">	<span class="comment">//插入这3个类型</span></span><br><span class="line">        <span class="string">'hset'</span>,</span><br><span class="line">        <span class="string">'hget'</span>,</span><br><span class="line">        <span class="string">'hdel'</span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Resque_RedisCluster</span> <span class="keyword">extends</span> <span class="title">RedisentCluster</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $keyCommands = <span class="keyword">array</span>(</span><br><span class="line">            ...</span><br><span class="line">    	<span class="string">'zremrangebyscore'</span>,</span><br><span class="line">	<span class="string">'sort'</span>,</span><br><span class="line">	<span class="comment">//插入这3个类型</span></span><br><span class="line">        <span class="string">'hset'</span>,</span><br><span class="line">        <span class="string">'hget'</span>,</span><br><span class="line">        <span class="string">'hdel'</span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Resque_Worker 每次判断是否有到达时间的Job<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">class Resque_Worker&#123;</span><br><span class="line">	public function work($interval = 5)</span><br><span class="line">	&#123;</span><br><span class="line">		$this-&gt;updateProcLine(&apos;Starting&apos;);</span><br><span class="line">		$this-&gt;startup();</span><br><span class="line">		while(true) &#123;</span><br><span class="line">			if($this-&gt;shutdown) &#123;</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">			$this-&gt;loadDelay();// 加载延迟执行</span><br><span class="line">			</span><br><span class="line">			... </span><br><span class="line">			&#125;</span><br><span class="line">     &#125;</span><br><span class="line">    </span><br><span class="line">      /**</span><br><span class="line">     * 延迟执行 移动队列位置</span><br><span class="line">     */</span><br><span class="line">	public function loadDelay()&#123;</span><br><span class="line">        $queues = $this-&gt;queues();</span><br><span class="line">        if($queues)&#123;</span><br><span class="line">        	foreach ($queues as $queue)&#123;</span><br><span class="line">                $this-&gt;log(&apos;Checking Delay&apos; . $queue, self::LOG_VERBOSE);</span><br><span class="line">                 Resque_Job::loadDelay($queue);</span><br><span class="line"></span><br><span class="line">	        &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>class Resque 中加入3个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">class Resque&#123;</span><br><span class="line">    </span><br><span class="line">    public static function later($queue,$item,$delay)&#123;</span><br><span class="line">        self::redis()-&gt;sadd(&apos;queues&apos;, $queue);</span><br><span class="line">        self::redis()-&gt;hset(&apos;delays:&apos;.$queue, $item[&apos;id&apos;], json_encode($item));</span><br><span class="line">        self::redis()-&gt;zadd(&apos;delay:&apos;.$queue,time() + $delay, $item[&apos;id&apos;]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 从 哈希数据移动到队列</span><br><span class="line">     *</span><br><span class="line">     * @param $queue</span><br><span class="line">     */</span><br><span class="line">    public static function move($queue)&#123;</span><br><span class="line">     // 获取前一千个满足条件的数据</span><br><span class="line">      $zDelayKeys =   self::redis()-&gt;zrangebyscore(&apos;delay:&apos;.$queue,0,time(),&apos;limit&apos;,0,1000);</span><br><span class="line"></span><br><span class="line">      if($zDelayKeys )&#123;</span><br><span class="line">          foreach ($zDelayKeys as $delayKey)&#123;</span><br><span class="line">              $item = self::redis()-&gt;hget(&apos;delays:&apos;.$queue,$delayKey);</span><br><span class="line">              if ($item) &#123;</span><br><span class="line">                  $delete = self::redis()-&gt;hdel(&apos;delays:&apos; . $queue, $delayKey);</span><br><span class="line">                  if ($delete &gt; 0) &#123; //可能有多个WORK 以删除为准</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                      self::redis()-&gt;sadd(&apos;queues&apos;, $queue);</span><br><span class="line">                      self::redis()-&gt;rpush(&apos;queue:&apos; . $queue, $item); //无需再json_encode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                      self::redis()-&gt;zrem(&apos;delay:&apos; . $queue,$delayKey);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;else&#123;</span><br><span class="line">                  self::redis()-&gt;zrem(&apos;delay:&apos; . $queue,$delayKey);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return true;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    public static function delay($queue, $class, $args = null,$delayTime = 60, $trackStatus = false)</span><br><span class="line">    &#123;</span><br><span class="line">        require_once dirname(__FILE__) . &apos;/Resque/Job.php&apos;;</span><br><span class="line">        $result = Resque_Job::delay($queue, $class, $args, $delayTime,$trackStatus);</span><br><span class="line">        if ($result) &#123;</span><br><span class="line">            Resque_Event::trigger(&apos;afterDelay&apos;, array(</span><br><span class="line">                &apos;class&apos; =&gt; $class,</span><br><span class="line">                &apos;args&apos;  =&gt; $args,</span><br><span class="line">                &apos;queue&apos; =&gt; $queue,</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>调用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//Job中失败时</span><br><span class="line"></span><br><span class="line">//$this-&gt;try_time  表示执行次数</span><br><span class="line">if ($this-&gt;try_time &lt; 3) &#123;</span><br><span class="line">    $this-&gt;job-&gt;delayJob(5 * 60); //5分钟后重新执行</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//其他地方直接调用</span><br><span class="line">Resque::delay($queue, $class, $args,$delayTime,$trackStatus);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yanqibin.github.io/2017/12/15/solr介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanqibin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yanqibin 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/15/solr介绍/" itemprop="url">solr介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-15T08:46:01+08:00">
                2017-12-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="solr是什么呢？"><a href="#solr是什么呢？" class="headerlink" title="solr是什么呢？"></a>solr是什么呢？</h3><blockquote>
<p>一、Solr它是一种开放源码的、基于 Lucene Java 的搜索服务器，易于加入到 Web 应用程序中。</p>
<p>二、Solr 提供了层面搜索(就是统计)、命中醒目显示并且支持多种输出格式（包括XML/XSLT 和JSON等格式）。它易于安装和配置，而且附带了一个基于 HTTP 的<br>管理界面。Solr已经在众多大型的网站中使用，较为成熟和稳定。</p>
<p>三、Solr 包装并扩展了Lucene，所以Solr的基本上沿用了Lucene的相关术语。更重要的是，Solr 创建的索引与 Lucene 搜索引擎库完全兼容。</p>
<p>四、通过对Solr 进行适当的配置，某些情况下可能需要进行编码，Solr 可以阅读和使用构建到其他 Lucene 应用程序中的索引。</p>
<p>五、此外，很多 Lucene 工具（如Nutch、 Luke）也可以使用Solr 创建的索引。可以使用 Solr 的表现优异的基本搜索功能，也可以对它进行扩展从而满足企业的需要。</p>
</blockquote>
<h3 id="solr的优点"><a href="#solr的优点" class="headerlink" title="solr的优点"></a>solr的优点</h3><p>①高级的全文搜索功能；<br>②专为高通量的网络流量进行的优化；<br>③基于开放接口（XML和HTTP）的标准；<br>④综合的HTML管理界面；<br>⑤可伸缩性－能够有效地复制到另外一个Solr搜索服务器；<br>⑥使用XML配置达到灵活性和适配性；<br>⑦可扩展的插件体系。</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p> schema.xml /managed-schema</p>
<ul>
<li>主键 默认为id<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;uniqueKey&gt;id&lt;/uniqueKey&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>字段类型</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">&lt;!--int 类型  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"int"</span> <span class="attr">class</span>=<span class="string">"solr.TrieIntField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span><span class="attr">precisionStep</span>=<span class="string">"0"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--IKAnalyzer 分词器配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"text_ik"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"index"</span> <span class="attr">class</span>=<span class="string">"org.wltea.analyzer.lucene.IKAnalyzer"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"query"</span> <span class="attr">class</span>=<span class="string">"org.wltea.analyzer.lucene.IKAnalyzer"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加字段</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 主键必须存在 ，且当id 为主键时 类型必须为string--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">type</span>=<span class="string">"string"</span> <span class="attr">multiValued</span>=<span class="string">"false"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> <span class="attr">required</span>=<span class="string">"true"</span> <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"products_name"</span> <span class="attr">type</span>=<span class="string">"text_ik"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 动态字段  类似xxx_s的字段 无需添加名称， 类型默认为 string--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_s"</span> <span class="attr">type</span>=<span class="string">"string"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>主键为比较项目 且类型为 string </p>
</blockquote>
<h3 id="php-对接-solr"><a href="#php-对接-solr" class="headerlink" title="php 对接 solr"></a>php 对接 solr</h3><ul>
<li><p>安装 solr扩展</p>
<ul>
<li>下载地址 <code>http://pecl.php.net/package/solr</code><blockquote>
<p>目前我们使用的是最新版 2.4.0</p>
</blockquote>
</li>
<li>phpinfo 中出现 solr 则表示安装成功</li>
</ul>
</li>
<li><p>使用 solr</p>
<ul>
<li>文档地址 <code>http://php.net/manual/zh/book.solr.php</code></li>
<li>使用 SolrClient-&gt;qurey() 查询</li>
<li>使用 SolrClient-&gt;addDocument() 添加/更新文档</li>
</ul>
</li>
</ul>
<h3 id="业务流程图"><a href="#业务流程图" class="headerlink" title="业务流程图"></a>业务流程图</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">user-&gt;&gt;web:更新数据</span><br><span class="line">web-&gt;&gt;DB: 更新数据至数据库</span><br><span class="line">web-&gt;&gt;DB: 插入待更新solr数据</span><br><span class="line">timer-&gt;&gt;DB:获取要更新的数据</span><br><span class="line">DB-&gt;&gt;timer:返会更新数据</span><br><span class="line">timer-&gt;&gt;solr:推送更新数据至solr</span><br><span class="line">user-&gt;&gt;web:查询数据</span><br><span class="line">web-&gt;&gt;solr:获取数据</span><br><span class="line">solr-&gt;&gt;web:返回数据主键</span><br><span class="line">web-&gt;&gt;DB:通过主键获取数据</span><br><span class="line">web-&gt;&gt;user:展示数据</span><br></pre></td></tr></table></figure>
<p><img src="/uploads/images/solr.png" alt="image"></p>
<h3 id="solr-功能"><a href="#solr-功能" class="headerlink" title="solr 功能"></a>solr 功能</h3><ul>
<li>分词搜索<blockquote>
<p>例如: 将 搜索词 <code>花王纸尿裤</code>  拆分为 <code>花王</code> 和 <code>纸尿裤</code> 进行搜索</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>缺点:依赖分词器,分词结果可能与预想结果不同</p>
</blockquote>
<ul>
<li><p>模糊查询</p>
<blockquote>
<p>通过相似度进行搜索，查询达到某个相似度的数据</p>
</blockquote>
</li>
<li><p>权重</p>
<blockquote>
<p>为不同字段设置权重  ，对不同字段设置不同权重,通过权重计算得出排序</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>查询范围</p>
<blockquote>
<p> 例如:查询价格区间</p>
</blockquote>
</li>
<li><p>高亮显示</p>
<blockquote>
<p>将匹配到关键词高亮显示</p>
</blockquote>
</li>
<li><p>分组统计(Facet)</p>
<blockquote>
<p>产品匹配到的数据有几个在类目1，几个在类目2  几个在某个属性组中</p>
</blockquote>
</li>
<li><p>相似匹配</p>
<blockquote>
<p>匹配与当前商品相似的商品</p>
</blockquote>
</li>
<li><p>拼音检索</p>
<blockquote>
<p>通过拼音查询中文数据</p>
</blockquote>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yanqibin.github.io/2017/10/26/判断左右脑源码解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanqibin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yanqibin 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/26/判断左右脑源码解读/" itemprop="url">判断左右脑源码解读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-26T08:37:10+08:00">
                2017-10-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="左右脑源码解读"><a href="#左右脑源码解读" class="headerlink" title="左右脑源码解读"></a>左右脑源码解读</h2><blockquote>
<p>最近看看你的左右脑年龄可以说是非常火，朋友圈有不少朋友人在玩，也看到有大牛对代码进行了解决，对此我也颇感兴趣来解读一番。<br>地址 ：[<a href="http://game.if122.com" target="_blank" rel="noopener">http://game.if122.com</a>]</p>
</blockquote>
<h2 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析"></a>数据分析</h2><blockquote>
<p>查看其源码 与网络请求，发现其发起了两次请求 <code>js/index.json</code> 与<code>js/index_2.json</code>。</p>
</blockquote>
<ul>
<li><p>首先 是<code>js/index.json</code> ,返回结果为问题题目，共9个节点，第一个如下所示:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"question"</span>:<span class="string">"这个男人的眼睛是在一条直线上吗？"</span>,</span><br><span class="line">  <span class="attr">"answer"</span>:&#123;</span><br><span class="line">    <span class="attr">"是"</span>:<span class="string">"2"</span>,</span><br><span class="line">    <span class="attr">"否"</span>:<span class="string">"2"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"banner"</span>:<span class="string">"images/1_pWzVxxQ.jpg"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>js/index_2.json</code> 中返回年龄与应该展示共个4个节点 每个节点中的word分别为a,b,c,d，第一个节点如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"word"</span>:<span class="string">"a"</span>,</span><br><span class="line">  <span class="attr">"name"</span>:&#123;</span><br><span class="line">    <span class="attr">"one"</span>:<span class="string">"25与27岁"</span>,</span><br><span class="line">    <span class="attr">"two"</span>:<span class="string">"39与22岁"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"output"</span>:</span><br><span class="line">  &#123;<span class="attr">"img"</span>:<span class="string">"images/86DA2WyG5I5uXM1.jpg"</span>,</span><br><span class="line">    <span class="attr">"text"</span>:<span class="string">"李白属于灵活走位，多段位移，七进七出，秀你一脸，比较吃操作的英雄，因此玩家的意识要特别强，才能将该英雄玩的很好。需要多熟悉、多玩，对应新手来说，不是特别适合。"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"outputtwo"</span>:</span><br><span class="line">  &#123;<span class="attr">"img"</span>:<span class="string">"images/ngeG9PYKAYsdqHtZ.jpg"</span>,</span><br><span class="line">    <span class="attr">"text"</span>:<span class="string">"李白属于灵活走位，多段位移，七进七出，秀你一脸，比较吃操作的英雄，因此玩家的意识要特别强，才能将该英雄玩的很好。需要多熟悉、多玩，对应新手来说，不是特别适合。"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><ul>
<li><p>查看js源码 其中有两个随机数 ansrandom，ansrandom2，ansrandom2 先来看 ansrandom2 ，ansrandom2 的取值只与 <code>.ad_after .ad_after_section</code>  有关，查看源码， 里面显示的是二维码等，所以与年龄判断无关,关键代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(ansrandom2%<span class="number">4</span>==<span class="number">0</span>)&#123;</span><br><span class="line">	$(<span class="string">'.ad_after .ad_after_section:eq(0)'</span>)</span><br><span class="line">	.css(<span class="string">'display'</span>,<span class="string">'flex'</span>)</span><br><span class="line">	.siblings()</span><br><span class="line">	.hide()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看 ansrandom  ,其结果为选择<code>js/index_2.json</code>  选中节点中的随机一个年龄</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span>(ansrandom%<span class="number">2</span>==<span class="number">1</span>)&#123;</span><br><span class="line"> 	$(<span class="string">'.result'</span>).prepend(<span class="string">'&lt;img src="'</span>+result[index].output.img+<span class="string">'"class="result_img"/&gt;'</span>)</span><br><span class="line"> 	.find(<span class="string">'span'</span>).text(result[index].name.one);	</span><br><span class="line">	$(<span class="string">'title'</span>).text(<span class="string">'原来我左右脑年龄是'</span>+result[index].name.one+<span class="string">'，你也来看看'</span>);</span><br><span class="line"> &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//设置 outputtwo 略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>接下来判断他是如何选中 <code>js/index_2.json</code>  中的节点的<br>关键代码:<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// isNaN 来判断是否是最后一题</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">isNaN</span>($(<span class="keyword">this</span>).data(<span class="string">"math"</span>)))&#123;</span><br><span class="line">	<span class="comment">//不是最后一题目 进入下一题</span></span><br><span class="line">    <span class="keyword">var</span> num_a=$(<span class="keyword">this</span>).data(<span class="string">"math"</span>)<span class="number">-1</span>	$(<span class="string">".question:eq("</span>+num_a+<span class="string">")"</span>).show().siblings().hide()</span><br><span class="line">    json[num_a].banner?$(<span class="string">".banner"</span>).prop(<span class="string">'src'</span>,json[num_a].banner):$(<span class="string">".banner"</span>).prop(<span class="string">'src'</span>, json[<span class="number">0</span>].banner)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="comment">//最后一题目显示结果</span></span><br><span class="line">	    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>通过<code>js/index.json</code>  中的<code>answer</code> 选择来跳转下一题，而 answer 的 中不同答案除了最后一个，都是相同而是 2，3,4,5,6,7,8,9 最后一个则分表为 abcd<br>所以前几题的结果都是无用的 年龄判断只与之后一题有关，<br>最后一题的<code>$(this).data(&quot;math&quot;);</code>中放的分别是 abcd ，通过匹配abcd 在<code>js/index_2.json</code> 中选择出word 相同的节点，再通过 ansrandom 再在节点中随机选个年龄来展示。</li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li>通过上一题的答案来选择下一题，但除最后一题外，跳转的题目都相同，故没有意义。</li>
<li>最后结果只与最后一题有关，在从你选择的答案中，从预设对应答案中选择选择一个来展示。 </li>
<li>答案对应年龄：</li>
</ol>
<ul>
<li>a: 25与27岁   或  39与22岁</li>
<li>b: 30与49岁   或  9岁与26岁</li>
<li>c: 46岁与19岁 或  33岁与5岁</li>
<li>d: 19与20岁</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yanqibin.github.io/2017/08/08/汽配兼容属性总表更新/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanqibin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yanqibin 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/08/汽配兼容属性总表更新/" itemprop="url">汽配兼容属性总表更新</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-08T23:34:15+08:00">
                2017-08-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>从ERP获取汽配属性到站内</p>
<h2 id="属性结构"><a href="#属性结构" class="headerlink" title="属性结构"></a>属性结构</h2><ul>
<li><p>每条兼容属性都挂在一个类目下</p>
</li>
<li><p>ERP 中的属性关联结构如下</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">Model--&gt;Make</span><br><span class="line">Make--&gt;Year</span><br><span class="line">Make--&gt;Engine</span><br><span class="line">Make--&gt;Trim</span><br></pre></td></tr></table></figure>
<ul>
<li>站内需要的结构如下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">Year--&gt;Make</span><br><span class="line">Make--&gt;Model</span><br><span class="line">Model--&gt;Engine</span><br><span class="line">Engine--&gt;Trim</span><br></pre></td></tr></table></figure>
<h2 id="实现方案探究"><a href="#实现方案探究" class="headerlink" title="实现方案探究"></a>实现方案探究</h2><ul>
<li><p>使用ERP结构进行存储</p>
<pre><code>建立5张表对应每个关联结构 记录条数与ERP中条数相同
</code></pre><p>缺点:</p>
<ul>
<li>每次查询都要带上父级类目进行管理查询</li>
<li>结构复杂</li>
<li>ERP结构变更</li>
</ul>
<p>优点： </p>
<ul>
<li>存储量小</li>
</ul>
</li>
<li><p>使用站内结构</p>
<pre><code>建立一张表 一条记录对应一个链式关系,如果ERP 中的条数为4n, 则站内对应条数n^4
</code></pre><p> 缺点：</p>
<ul>
<li><p>数据量大</p>
<p>优点： </p>
<ul>
<li>结构简单</li>
<li>查询方便</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><pre><code>使用一条记录对应一个链式关系的方式存
</code></pre><ul>
<li>结构如下</li>
</ul>
<table>
<thead>
<tr>
<th>表字段名</th>
<th>字段</th>
</tr>
</thead>
<tbody>
<tr>
<td>catetory</td>
<td>varchar(30)</td>
</tr>
<tr>
<td>year</td>
<td>smallint</td>
</tr>
<tr>
<td>make</td>
<td>varchar(30)</td>
</tr>
<tr>
<td>model</td>
<td>varchar(30)</td>
</tr>
<tr>
<td>egine</td>
<td>varchar(30)</td>
</tr>
<tr>
<td>trim</td>
<td>varchar(30)</td>
</tr>
</tbody>
</table>
<ul>
<li><p>实现</p>
<p>  遍历获取ERP兼容属性，完成一个完成的关系链，插入数据库</p>
</li>
<li><p>优化</p>
<p> 由于是 n^4 的记录条数，数据达到了恐怖的亿级</p>
<ul>
<li><p>在结构上根据year水平分表，分成10个表，每个表只记录一个 year 位数的数据，插入 数据是 批量插入，采用如下形式，每千条插入一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into table(year,make...) values (value1,value2...),(value1,value2...)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在查询上 建立关联索引 year-&gt;make-&gt;model-&gt;engine-&gt;trim</p>
</li>
<li>year层 union 查询 生产缓存</li>
<li>make 层 是用索引后 搜索的条数仍然达到了千万级别，仍使用缓存</li>
<li>model,engine,trim 搜索的条数就在百万级以下 查询速度感人，没有继续优化</li>
</ul>
</li>
<li><p>成果</p>
<ul>
<li>innodb 下使用了将近50G的服务硬盘</li>
<li><p>更新一个类目耗时4,5个小时</p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>到此完成了数据从ERP到站内的需求,总体来说，是用空间来换数据结构。<br>虽然解决了对总表的更新，但感觉还有许多不足,期望日后能加以完善。</p>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yanqibin.github.io/2017/08/07/数独-回溯算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanqibin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yanqibin 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/07/数独-回溯算法/" itemprop="url">数独 回溯算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-07T22:21:36+08:00">
                2017-08-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="数独-回溯算法，计算未填写的-九宫格"><a href="#数独-回溯算法，计算未填写的-九宫格" class="headerlink" title="数独 回溯算法，计算未填写的 九宫格"></a>数独 回溯算法，计算未填写的 九宫格</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $bord;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $bord)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bord = $bord;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $pos = <span class="keyword">$this</span>-&gt;next();</span><br><span class="line">      <span class="comment">// var_dump($pos);</span></span><br><span class="line">        <span class="keyword">if</span> ($pos == <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">list</span>($x, $y) = $pos;</span><br><span class="line"><span class="comment">//       echo $this-&gt;string($x,$y);</span></span><br><span class="line"><span class="comment">//       echo '&lt;br/&gt;';</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ($v = <span class="number">1</span>; $v &lt; <span class="number">10</span>; $v++) &#123;</span><br><span class="line">          <span class="comment">//  var_dump($x, $y, $v);</span></span><br><span class="line">           <span class="comment">// var_dump($this-&gt;check($x, $y, $v));</span></span><br><span class="line">          <span class="comment">//echo $this-&gt;__toString();</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;check($x, $y, $v)) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;set($x, $y, $v);</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;run())&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;release($x, $y);</span><br><span class="line">     <span class="comment">//   $this-&gt;run();</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;bord <span class="keyword">as</span> $x =&gt; $array) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($array <span class="keyword">as</span> $y =&gt; $v) &#123;</span><br><span class="line">                <span class="keyword">if</span> ($v == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> [$x, $y];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($x, $y, $v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;bord <span class="keyword">as</span>  $x_a) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ($x_a[$y] == $v) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;bord[$x] <span class="keyword">as</span> $y_v) &#123;</span><br><span class="line">           <span class="comment">// var_dump($y_v);</span></span><br><span class="line">            <span class="keyword">if</span> ($y_v == $v) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $x_b = intval(floor(($x<span class="number">-1</span>)/<span class="number">3</span>)*<span class="number">3</span> +<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        $y_b = intval(floor(($y<span class="number">-1</span>)/<span class="number">3</span>)*<span class="number">3</span> +<span class="number">1</span>);</span><br><span class="line">       <span class="comment">// var_dump('x',$x_b);var_dump('y',$y_b);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ($x = $x_b; $x &lt; $x_b + <span class="number">3</span>; $x++) &#123;</span><br><span class="line">            <span class="keyword">for</span> ($y = $y_b; $y &lt; $y_b + <span class="number">3</span>; $y++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;bord[$x][$y] ==$v)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($x, $y, $v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bord[$x][$y] = $v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">complete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;next() === <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">release</span><span class="params">($x, $y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bord[$x][$y] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">string</span><span class="params">($x_r=null,$y_r=null)</span> </span>&#123;</span><br><span class="line">        $str = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;bord <span class="keyword">as</span> $x =&gt; $array) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($array <span class="keyword">as</span> $y =&gt; $v) &#123;</span><br><span class="line">                <span class="keyword">if</span>($x_r &amp;&amp; $y_r &amp;&amp; $x_r==$x &amp;&amp; $y_r==$y)&#123;</span><br><span class="line">                    $str .= <span class="string">'&lt;span style="color:red"&gt;'</span>.$v . <span class="string">'&lt;/span&gt;&amp;nbsp; &amp;nbsp;  '</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    $str .= $v . <span class="string">'&amp;nbsp; &amp;nbsp;  '</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            $str .= <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $str = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;bord <span class="keyword">as</span> $x =&gt; $array) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($array <span class="keyword">as</span> $y =&gt; $v) &#123;</span><br><span class="line">                    $str .= $v . <span class="string">'&amp;nbsp; &amp;nbsp;'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $str .= <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$bord  = <span class="keyword">new</span> bord(array_fill(<span class="number">1</span>,<span class="number">9</span>,array_fill(<span class="number">1</span>,<span class="number">9</span>,<span class="number">0</span>)));</span><br><span class="line">$bord -&gt;run();</span><br><span class="line"><span class="keyword">echo</span> $bord ;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yanqibin.github.io/2017/08/07/js-中参数的获取/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanqibin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yanqibin 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/07/js-中参数的获取/" itemprop="url">js 中参数的获取</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-07T22:16:35+08:00">
                2017-08-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="js-中参数的获取"><a href="#js-中参数的获取" class="headerlink" title="js 中参数的获取"></a>js 中参数的获取</h2><ol>
<li><p>柯里化(currying)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">y</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.info(x+y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">foo(<span class="number">5</span>)(<span class="number">6</span>);<span class="comment">// 11 ，如果方法中没有改变量，则向上层寻找</span></span><br><span class="line"><span class="keyword">new</span> foo; <span class="comment">//注意，此时返回的不是foo 对象（注释1）</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>arguments，获取方法传入的所有值（场景：参数不固定）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="built_in">arguments</span>)</span><br><span class="line">&#125;</span><br><span class="line">foo(<span class="number">1</span>,<span class="number">2</span>);<span class="comment">//[1,2]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>…x 类似php 5.6 特性中的参数获取</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> (<span class="params">...x</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> z <span class="keyword">of</span> x)&#123;</span><br><span class="line">         <span class="built_in">console</span>.warn(z)</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p>1 . 当 方法返回一个 对象，或一个方法时,实例化这个方法时，得到他的返回值的实例</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/uploads/images/avatar.jpg" alt="yanqibin">
          <p class="site-author-name" itemprop="name">yanqibin</p>
           
              <p class="site-description motion-element" itemprop="description">yanqibin</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yanqibin</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
